---
/**
 * Metadata - SEO and social media metadata generation
 * @props title, ignoreTitleTemplate, canonical, robots, description, openGraph, twitter, alternateLanguages
 * @behavior Generates comprehensive meta tags for SEO, Open Graph, and Twitter
 * @dependencies AstroSeo, seez.config for metadata defaults, utils for canonical URLs and images
 * @usedBy Layout.astro, MarkdownLayout.astro, PageLayout.astro, all page components
 */
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { getSiteInfo, getMetadataConfig, getI18nConfig } from '~/config/seez.config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';

const siteInfo = getSiteInfo();
const metadataConfig = getMetadataConfig();
const i18nConfig = getI18nConfig();

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
  alternateLanguages?: Array<{ href: string; hreflang: string }>;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
  alternateLanguages = [],
} = Astro.props;

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: siteInfo.name,
      images: [],
      locale: i18nConfig.defaultLanguage || 'en',
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: metadataConfig.title?.default,
    titleTemplate: metadataConfig.title?.template,
    noindex: typeof metadataConfig.robots?.index !== 'undefined' ? !metadataConfig.robots.index : undefined,
    nofollow: typeof metadataConfig.robots?.follow !== 'undefined' ? !metadataConfig.robots.follow : undefined,
    description: metadataConfig.description,
    openGraph: metadataConfig.openGraph,
    twitter: metadataConfig.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  }
);
---

<AstroSeo {...{ ...seoProps, openGraph: await adaptOpenGraphImages(seoProps?.openGraph, Astro.site) }} />

<!-- Hreflang alternate language tags for SEO -->
{alternateLanguages.map(({ href, hreflang }) => <link rel="alternate" hreflang={hreflang} href={href} />)}
{alternateLanguages.length > 0 && <link rel="alternate" hreflang="x-default" href={canonical} />}
