---
/**
 * GitHubSourceButton - Enhanced GitHub integration with source and commit history links
 * @props filePath - The source file path relative to the repository root
 * @props locale - Current language for proper translation
 * @props showHistory - Whether to show commit history option
 * @behavior - Displays buttons linking to GitHub source and commit history
 * @dependencies - Icon component, i18n utilities
 * @usedBy - MarkdownLayout and other content layouts
 */

import { Icon } from 'astro-icon/components';
import { getTranslations } from '~/utils/i18n';

export interface Props {
  filePath?: string;
  locale?: 'en' | 'de';
  showHistory?: boolean;
  className?: string;
}

const { filePath, locale = 'en', showHistory = true, className = '' } = Astro.props;

// Get translations
const safeLocale: 'en' | 'de' = locale === 'de' ? 'de' : 'en';
const translations = await getTranslations(safeLocale);
const t = (key: string) => {
  const keys = key.split('.');
  let value: unknown = translations;
  for (const k of keys) {
    value = (value as Record<string, unknown>)?.[k];
    if (value === undefined) break;
  }
  return (value as string) || key;
};

// Build GitHub URLs
const GITHUB_REPO = 'https://github.com/PatrickBziuk/seez';
const GITHUB_BRANCH = 'main';

function buildGitHubUrls(filePath?: string): { sourceUrl: string; historyUrl: string } {
  if (!filePath) {
    return {
      sourceUrl: GITHUB_REPO,
      historyUrl: GITHUB_REPO,
    };
  }

  // Clean up the file path
  const cleanPath = filePath.startsWith('/') ? filePath.slice(1) : filePath;

  // Build the URLs
  const sourceUrl = `${GITHUB_REPO}/blob/${GITHUB_BRANCH}/${cleanPath}`;
  const historyUrl = `${GITHUB_REPO}/commits/${GITHUB_BRANCH}/${cleanPath}`;

  return { sourceUrl, historyUrl };
}

const { sourceUrl, historyUrl } = buildGitHubUrls(filePath);
const sourceButtonText = t('button.view_source');
const historyButtonText = t('button.view_history') || 'View History';
---

{
  showHistory ? (
    <div class={`github-buttons flex items-center gap-2 ${className}`}>
      <a
        href={sourceUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="github-source-button inline-flex items-center gap-2 px-3 py-2 text-sm
        bg-gray-50 hover:bg-gray-100 dark:bg-gray-800 dark:hover:bg-gray-700
        border border-gray-200 dark:border-gray-700 rounded-md
        text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100
        transition-colors duration-200 no-underline"
        title={sourceButtonText}
        aria-label={`${sourceButtonText} - ${sourceUrl}`}
      >
        <Icon name="tabler:brand-github" class="w-4 h-4" />
        <span>Source</span>
      </a>

      <a
        href={historyUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="github-history-button inline-flex items-center gap-2 px-3 py-2 text-sm
        bg-gray-50 hover:bg-gray-100 dark:bg-gray-800 dark:hover:bg-gray-700
        border border-gray-200 dark:border-gray-700 rounded-md
        text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100
        transition-colors duration-200 no-underline"
        title={historyButtonText}
        aria-label={`${historyButtonText} - ${historyUrl}`}
      >
        <Icon name="tabler:history" class="w-4 h-4" />
        <span>History</span>
      </a>
    </div>
  ) : (
    <a
      href={sourceUrl}
      target="_blank"
      rel="noopener noreferrer"
      class={`
      github-source-button inline-flex items-center gap-2 px-3 py-2 text-sm
      bg-gray-50 hover:bg-gray-100 dark:bg-gray-800 dark:hover:bg-gray-700
      border border-gray-200 dark:border-gray-700 rounded-md
      text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100
      transition-colors duration-200 no-underline
      ${className}
    `}
      title={sourceButtonText}
      aria-label={`${sourceButtonText} - ${sourceUrl}`}
    >
      <Icon name="tabler:brand-github" class="w-4 h-4" />
      <span>{sourceButtonText}</span>
    </a>
  )
}

<style>
  .github-source-button:focus,
  .github-history-button:focus {
    outline: 2px solid rgb(59 130 246);
    outline-offset: 2px;
  }

  .github-source-button:focus:not(:focus-visible),
  .github-history-button:focus:not(:focus-visible) {
    outline: none;
  }
</style>
